name: RDP with Tailscale

on: workflow_dispatch

jobs:
  rdp:
    runs-on: windows-latest
    timeout-minutes: 360
    
    steps:
    - name: Install Tailscale
      shell: powershell
      env:
        TS_AUTH_KEY: ${{ secrets.TS_AUTH_KEY }}
      run: |
        # Download Tailscale
        Write-Host "Downloading Tailscale..."
        Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe" -OutFile "tailscale.exe" -UseBasicParsing
        
        # Install silently
        Write-Host "Installing Tailscale..."
        Start-Process -FilePath ".\tailscale.exe" -ArgumentList "/S" -Wait
        Start-Sleep -Seconds 10
        
        # Connect to Tailscale
        Write-Host "Connecting to Tailscale network..."
        & "C:\Program Files\Tailscale\tailscale.exe" up --authkey="$env:TS_AUTH_KEY" --hostname="github-rdp"
        
        # Get IP
        $ip = & "C:\Program Files\Tailscale\tailscale.exe" ip -4
        Write-Host "Tailscale IP: $ip"
        
        # Save IP to file
        $ip | Out-File -FilePath "tailscale-ip.txt"
    
    - name: Enable RDP (FIXED - No Error)
      shell: powershell
      run: |
        Write-Host "=== Setting up RDP ==="
        
        # Enable RDP - suppress all errors
        try {
            reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f 2>$null
            Write-Host "‚úì RDP enabled in registry"
        } catch {}
        
        # Enable NLA
        try {
            reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v UserAuthentication /t REG_DWORD /d 1 /f 2>$null
            Write-Host "‚úì NLA enabled"
        } catch {}
        
        # Configure firewall - suppress output
        try {
            netsh advfirewall firewall set rule group="remote desktop" new enable=Yes 2>$null
            Write-Host "‚úì Firewall configured"
        } catch {}
        
        # Start service - ignore if already running
        try {
            net start TermService 2>$null
            Write-Host "‚úì Terminal service started"
        } catch {
            Write-Host "‚Ñπ Terminal service already running (this is OK)"
        }
        
        Write-Host "‚úÖ RDP setup completed"
    
    - name: Create User
      shell: powershell
      run: |
        Write-Host "Creating RDP user..."
        
        # Create user with random password
        $password = "GitHub@" + (Get-Random -Minimum 10000 -Maximum 99999)
        $username = "rdpuser"
        
        # Delete user if exists (to avoid errors)
        net user $username /delete 2>$null
        
        # Create new user
        net user $username $password /add /Y
        net localgroup administrators $username /add
        net localgroup "Remote Desktop Users" $username /add
        
        Write-Host "User created!"
        Write-Host "Username: $username"
        Write-Host "Password: $password"
    
    - name: Display Connection Info
      shell: powershell
      run: |
        # Get Tailscale IP
        $ip = Get-Content -Path "tailscale-ip.txt" -ErrorAction SilentlyContinue
        if (-not $ip) {
            $ip = & "C:\Program Files\Tailscale\tailscale.exe" ip -4
        }
        
        Write-Host "=========================================="
        Write-Host "üéØ RDP READY TO CONNECT"
        Write-Host "=========================================="
        Write-Host "IP Address: $ip"
        Write-Host "Username: rdpuser"
        Write-Host "Password: Check previous step output"
        Write-Host ""
        Write-Host "üíª Connect using: mstsc /v:$ip"
        Write-Host ""
        Write-Host "‚è∞ Session will run for 6 hours"
        Write-Host "=========================================="
    
    - name: Keep Alive
      shell: powershell
      run: |
        Write-Host "üîÑ Keeping RDP session alive for 6 hours..."
        
        # Simple keep-alive - NO ERRORS
        for ($i = 1; $i -le 360; $i++) {
            # Show status every 5 minutes
            if (($i % 5) -eq 0) {
                $ip = & "C:\Program Files\Tailscale\tailscale.exe" ip -4 2>$null
                Write-Host "[$(Get-Date -Format 'HH:mm')] Active - IP: $ip"
            }
            Start-Sleep -Seconds 10
        }
        
        Write-Host "‚è∞ 6 hours completed. Goodbye!"

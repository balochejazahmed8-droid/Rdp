name: RDP with Bitcoin Tools
on: workflow_dispatch

jobs:
  setup:
    runs-on: windows-latest
    timeout-minutes: 360
    
    steps:
    - name: Setup Tailscale
      shell: powershell
      env:
        TS_AUTH_KEY: ${{ secrets.TS_AUTH_KEY }}
      run: |
        Write-Host "Step 1/4: Installing Tailscale..."
        
        $tailscaleUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe"
        $installerPath = "$env:TEMP\tailscale.exe"
        
        Invoke-WebRequest -Uri $tailscaleUrl -OutFile $installerPath -UseBasicParsing
        Start-Process -FilePath $installerPath -ArgumentList "/S" -Wait -NoNewWindow
        Start-Sleep -Seconds 5
        
        & "C:\Program Files\Tailscale\tailscale.exe" up --authkey="$env:TS_AUTH_KEY" --hostname="github-rdp"
        $ip = & "C:\Program Files\Tailscale\tailscale.exe" ip -4
        Write-Host "IP: $ip"
        $ip | Out-File -FilePath "$env:GITHUB_WORKSPACE\ip.txt"
        
    - name: Enable RDP
      shell: powershell
      run: |
        Write-Host "Step 2/4: Enabling Remote Desktop..."
        
        Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop" -ErrorAction SilentlyContinue
        
        $password = ConvertTo-SecureString "Password123!" -AsPlainText -Force
        $username = "rdpuser"
        
        New-LocalUser -Name $username -Password $password -ErrorAction SilentlyContinue
        Add-LocalGroupMember -Group "Administrators" -Member $username -ErrorAction SilentlyContinue
        Write-Host "User created"
        
    - name: Setup Bitcoin Tools
      shell: powershell
      run: |
        Write-Host "Step 3/4: Setting up Bitcoin tools..."
        
        # Create directory
        $toolsDir = "C:\BitcoinTools"
        New-Item -ItemType Directory -Path $toolsDir -Force
        
        # Create README file - FIXED SYNTAX
        $readmeContent = @'
BITCOIN VANITY ADDRESS TOOLS SETUP
==================================

1. VanitySearch (Main Tool)
   Download from: https://github.com/JeanLucPons/VanitySearch/releases
   Save as: C:\BitcoinTools\VanitySearch.exe

2. Quick Start Commands:
   cd C:\BitcoinTools
   VanitySearch.exe -t 8 -o results.txt 1YourPattern

3. Python Script (Ready to use):
   cd C:\BitcoinTools
   python generate.py 1BTC

4. KeyHunt (Alternative):
   https://github.com/kanhavishva/KeyHunt-Cuda

==================================
RDP Connection Info:
IP: 
User: rdpuser
Pass: Password123!
'@
        
        # Add IP to README
        $ip = Get-Content "$env:GITHUB_WORKSPACE\ip.txt" -ErrorAction SilentlyContinue
        if ($ip) {
            $readmeContent = $readmeContent -replace 'IP: ', "IP: $ip"
        }
        
        Set-Content -Path "$toolsDir\README.txt" -Value $readmeContent -Encoding UTF8
        
        # Create Python script
        $pythonScript = @'
import hashlib
import base58
import secrets
print("Bitcoin Address Generator")
private_key = secrets.token_bytes(32)
hash1 = hashlib.sha256(private_key).digest()
ripemd160 = hashlib.new('ripemd160', hash1).digest()
version = b'\x00'
payload = version + ripemd160
checksum = hashlib.sha256(hashlib.sha256(payload).digest()).digest()[:4]
address = base58.b58encode(payload + checksum).decode()
print(f"Address: {address}")
'@
        
        Set-Content -Path "$toolsDir\generate.py" -Value $pythonScript -Encoding UTF8
        
        # Create batch file
        $batchContent = @'
@echo off
echo Bitcoin Vanity Address Generator
cd /d C:\BitcoinTools
echo Run: VanitySearch.exe -t 8 -o results.txt 1BTC
pause
'@
        
        Set-Content -Path "$toolsDir\start.bat" -Value $batchContent -Encoding ASCII
        
        Write-Host "Tools directory created at: $toolsDir"
        
    - name: Display Connection Info
      shell: powershell
      run: |
        Write-Host "Step 4/4: Setup complete!"
        Write-Host "=" * 50
        Write-Host "RDP WITH BITCOIN TOOLS READY"
        Write-Host "=" * 50
        
        $ip = Get-Content "$env:GITHUB_WORKSPACE\ip.txt" -ErrorAction SilentlyContinue
        if (-not $ip) {
            $ip = & "C:\Program Files\Tailscale\tailscale.exe" ip -4 2>$null
        }
        
        Write-Host "IP: $ip"
        Write-Host "User: rdpuser"
        Write-Host "Pass: Password123!"
        Write-Host "Tools: C:\BitcoinTools"
        Write-Host "=" * 50
        
    - name: Keep Session Alive
      shell: powershell
      run: Start-Sleep -Seconds 21600

name: RDP with Bitcoin Tools
on: workflow_dispatch

jobs:
  setup:
    runs-on: windows-latest
    timeout-minutes: 360
    
    steps:
    # STEP 1: Setup Tailscale
    - name: Setup Tailscale
      shell: powershell
      env:
        TS_AUTH_KEY: ${{ secrets.TS_AUTH_KEY }}
      run: |
        Write-Host "Step 1/4: Installing Tailscale..."
        
        # Download Tailscale
        $tailscaleUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe"
        $installerPath = "$env:TEMP\tailscale.exe"
        
        try {
            Invoke-WebRequest -Uri $tailscaleUrl -OutFile $installerPath -UseBasicParsing
            Write-Host "‚úì Tailscale downloaded"
        } catch {
            Write-Host "Trying alternate download method..."
            (New-Object System.Net.WebClient).DownloadFile($tailscaleUrl, $installerPath)
        }
        
        # Install Tailscale
        Start-Process -FilePath $installerPath -ArgumentList "/S" -Wait -NoNewWindow
        Start-Sleep -Seconds 5
        
        # Connect to Tailscale
        & "C:\Program Files\Tailscale\tailscale.exe" up --authkey="$env:TS_AUTH_KEY" --hostname="github-rdp-$env:GITHUB_RUN_ID"
        
        # Get IP
        $ip = & "C:\Program Files\Tailscale\tailscale.exe" ip -4
        Write-Host "‚úì Tailscale connected. IP: $ip"
        $ip | Out-File -FilePath "$env:GITHUB_WORKSPACE\ip.txt"
        
    # STEP 2: Enable RDP
    - name: Enable RDP
      shell: powershell
      run: |
        Write-Host "Step 2/4: Enabling Remote Desktop..."
        
        # Enable RDP in registry
        Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
        
        # Configure firewall
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop" -ErrorAction SilentlyContinue
        
        # Create user
        $password = ConvertTo-SecureString "Password123!" -AsPlainText -Force
        $username = "rdpuser"
        
        try {
            New-LocalUser -Name $username -Password $password -ErrorAction Stop
            Add-LocalGroupMember -Group "Administrators" -Member $username
            Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username
            Write-Host "‚úì User created: $username"
        } catch {
            Write-Host "User already exists or error creating"
        }
        
    # STEP 3: Setup Bitcoin Tools
    - name: Setup Bitcoin Tools
      shell: powershell
      run: |
        Write-Host "Step 3/4: Setting up Bitcoin tools..."
        
        # Create directory
        $toolsDir = "C:\BitcoinTools"
        New-Item -ItemType Directory -Path $toolsDir -Force
        
        # Create README file
        @"
BITCOIN VANITY ADDRESS TOOLS SETUP
==================================

1. VanitySearch (Main Tool)
   Download from: https://github.com/JeanLucPons/VanitySearch/releases
   Save as: C:\BitcoinTools\VanitySearch.exe

2. Quick Start Commands:
   cd C:\BitcoinTools
   VanitySearch.exe -t 8 -o results.txt 1YourPattern

3. Python Script (Ready to use):
   cd C:\BitcoinTools
   python generate.py 1BTC

4. KeyHunt (Alternative):
   https://github.com/kanhavishva/KeyHunt-Cuda

==================================
RDP Connection Info:
IP: $(Get-Content "$env:GITHUB_WORKSPACE\ip.txt" -ErrorAction SilentlyContinue)
User: rdpuser
Pass: Password123!
"@ | Out-File -FilePath "$toolsDir\README.txt" -Encoding UTF8
        
        # Create Python generator script
        @"
import hashlib
import base58
import secrets
import sys

def generate_address(prefix=""):
    count = 0
    print(f"Looking for address starting with: {prefix}")
    print("Press Ctrl+C to stop")
    
    try:
        while True:
            # Generate random private key
            private_key = secrets.token_bytes(32)
            
            # ECDSA (simplified - real implementation needs ecdsa library)
            # For demo, we'll just generate random addresses
            hash1 = hashlib.sha256(private_key).digest()
            ripemd160 = hashlib.new('ripemd160', hash1).digest()
            
            # Mainnet address (0x00)
            version = b'\x00'
            payload = version + ripemd160
            
            # Double SHA256 checksum
            checksum = hashlib.sha256(hashlib.sha256(payload).digest()).digest()[:4]
            
            # Base58 encode
            address = base58.b58encode(payload + checksum).decode()
            
            count += 1
            
            if prefix and address.startswith(prefix):
                print(f"\n‚úì Found after {count:,} attempts!")
                print(f"Address: {address}")
                return address
                
            if count % 10000 == 0:
                print(f"Checked {count:,} addresses...")
                
    except KeyboardInterrupt:
        print(f"\nStopped after {count:,} attempts")
        return None

if __name__ == "__main__":
    prefix = sys.argv[1] if len(sys.argv) > 1 else ""
    generate_address(prefix)
"@ | Out-File -FilePath "$toolsDir\generate.py" -Encoding UTF8
        
        # Create batch file to run VanitySearch
        @"
@echo off
echo Bitcoin Vanity Address Generator
echo ================================
echo.
echo Instructions:
echo 1. Download VanitySearch.exe from:
echo    https://github.com/JeanLucPons/VanitySearch/releases
echo 2. Save it to this folder (C:\BitcoinTools)
echo 3. Run this command:
echo    VanitySearch.exe -t 8 -o results.txt 1YourPattern
echo.
echo Example patterns: 1BTC, 1HODL, 1Love, 1MyWallet
echo.
pause
"@ | Out-File -FilePath "$toolsDir\start.bat" -Encoding ASCII
        
        Write-Host "‚úì Bitcoin tools directory created at: $toolsDir"
        
    # STEP 4: Display Info
    - name: Display Connection Info
      shell: powershell
      run: |
        Write-Host "Step 4/4: Final setup complete!"
        Write-Host "=" * 50
        Write-Host "‚úÖ RDP WITH BITCOIN TOOLS READY"
        Write-Host "=" * 50
        
        $ip = Get-Content "$env:GITHUB_WORKSPACE\ip.txt" -ErrorAction SilentlyContinue
        if (-not $ip) {
            $ip = & "C:\Program Files\Tailscale\tailscale.exe" ip -4 2>$null
        }
        
        Write-Host "üåê Connection Details:"
        Write-Host "IP Address: $ip"
        Write-Host "Username: rdpuser"
        Write-Host "Password: Password123!"
        Write-Host ""
        Write-Host "üí∞ Bitcoin Tools Location:"
        Write-Host "C:\BitcoinTools\"
        Write-Host ""
        Write-Host "üöÄ Quick Start After Connecting:"
        Write-Host "1. Open Command Prompt"
        Write-Host "2. Type: cd C:\BitcoinTools"
        Write-Host "3. Download VanitySearch from GitHub"
        Write-Host "4. Run: VanitySearch.exe -t 8 -o results.txt 1BTC"
        Write-Host ""
        Write-Host "‚è∞ Session Duration: 6 hours"
        Write-Host "=" * 50
        
    # STEP 5: Keep Alive
    - name: Keep Session Alive
      shell: powershell
      run: |
        Write-Host "üîÑ RDP session is now active and running..."
        Write-Host "Bitcoin tools are ready in C:\BitcoinTools"
        Write-Host ""
        
        # Display countdown
        $totalSeconds = 21600  # 6 hours
        for ($i = 1; $i -le $totalSeconds; $i++) {
            if ($i % 300 -eq 0) {  # Every 5 minutes
                $minutes = [math]::Round($i / 60)
                $hours = [math]::Round($minutes / 60, 1)
                Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Running for $minutes minutes ($hours hours)"
            }
            Start-Sleep -Seconds 1
        }
        
        Write-Host "‚è∞ 6 hours completed. Session ending."

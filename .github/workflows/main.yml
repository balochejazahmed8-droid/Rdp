name: RDP with Tailscale
on: workflow_dispatch

jobs:
  setup-rdp:
    runs-on: windows-latest
    timeout-minutes: 360
    
    steps:
    - name: Setup Tailscale and RDP
      shell: cmd
      env:
        TS_AUTH_KEY: ${{ secrets.TS_AUTH_KEY }}
      run: |
        @echo off
        
        echo ========================================
        echo 1. Installing Tailscale...
        echo ========================================
        
        REM Download Tailscale
        curl -L -o tailscale.exe https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe
        if exist tailscale.exe (
          echo Download successful
        ) else (
          echo Download failed
          exit 1
        )
        
        REM Install Tailscale silently
        tailscale.exe /S
        timeout /t 5
        
        REM Connect to Tailscale
        echo Connecting to Tailscale network...
        "C:\Program Files\Tailscale\tailscale.exe" up --authkey=%TS_AUTH_KEY% --hostname=github-rdp
        
        REM Get Tailscale IP
        for /f "tokens=*" %%i in ('"C:\Program Files\Tailscale\tailscale.exe" ip -4') do set TS_IP=%%i
        echo Tailscale IP: %TS_IP%
        
        echo ========================================
        echo 2. Setting up RDP...
        echo ========================================
        
        REM Enable RDP
        reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
        reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v UserAuthentication /t REG_DWORD /d 1 /f
        
        REM Configure firewall
        netsh advfirewall firewall set rule group="remote desktop" new enable=Yes
        
        REM Start Terminal Services (ignore if already running)
        net start TermService 2>nul || echo Service already running or error starting
        
        echo ========================================
        echo 3. Creating user...
        echo ========================================
        
        REM Create user with random password
        set /a RAND=%RANDOM% + 10000
        net user rdpuser GitHubRDP%RAND% /add /Y
        net localgroup administrators rdpuser /add
        net localgroup "Remote Desktop Users" rdpuser /add
        
        echo ========================================
        echo 4. RDP READY TO CONNECT
        echo ========================================
        echo IP Address: %TS_IP%
        echo Username: rdpuser
        echo Password: GitHubRDP%RAND%
        echo.
        echo Connect using: mstsc /v:%TS_IP%
        echo.
        echo This session will run for 6 hours
        echo ========================================
        
    - name: Keep RDP Session Alive
      shell: cmd
      run: |
        @echo off
        echo RDP session is now active...
        echo Keeping alive for 6 hours...
        echo.
        
        REM Simple keep-alive - run for 6 hours (21600 seconds)
        timeout /t 21600 /nobreak
        
        echo RDP session ended after 6 hours.

name: RDP + Bitcoin Vanity Solver
on: workflow_dispatch

jobs:
  setup-rdp:
    runs-on: windows-latest
    timeout-minutes: 360
    
    steps:
    - name: Setup Tailscale & RDP
      shell: cmd
      env:
        TS_AUTH_KEY: ${{ secrets.TS_AUTH_KEY }}
      run: |
        @echo off
        
        echo Step 1: Installing Tailscale...
        powershell -Command "Invoke-WebRequest -Uri 'https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe' -OutFile 'tailscale.exe' -UseBasicParsing"
        tailscale.exe /S
        timeout /t 3
        
        echo Step 2: Connecting Tailscale...
        "C:\Program Files\Tailscale\tailscale.exe" up --authkey=%TS_AUTH_KEY% --hostname=github-rdp
        
        echo Step 3: Enabling RDP...
        reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
        netsh advfirewall firewall set rule group="remote desktop" new enable=Yes
        
        echo Step 4: Creating user...
        net user rdpuser Password123! /add
        net localgroup administrators rdpuser /add
        
        echo Step 5: Getting IP...
        "C:\Program Files\Tailscale\tailscale.exe" ip -4 > ip.txt
        
    - name: Install VanitySearch (FIXED)
      shell: powershell
      run: |
        Write-Host "=== Installing VanitySearch ==="
        
        # Create directory
        New-Item -ItemType Directory -Path "C:\BitcoinTools" -Force
        
        # CORRECT VanitySearch download URL
        # Using direct download from GitHub
        $vanityUrl = "https://github.com/JeanLucPons/VanitySearch/releases/latest/download/VanitySearch.exe"
        $vanityPath = "C:\BitcoinTools\VanitySearch.exe"
        
        Write-Host "Downloading from: $vanityUrl"
        
        # Try multiple download methods
        try {
            # Method 1: Use WebClient
            $webClient = New-Object System.Net.WebClient
            $webClient.DownloadFile($vanityUrl, $vanityPath)
            Write-Host "✓ Download successful (WebClient)"
        }
        catch {
            Write-Host "Trying alternative download method..."
            try {
                # Method 2: Use Invoke-WebRequest
                Invoke-WebRequest -Uri $vanityUrl -OutFile $vanityPath -UseBasicParsing
                Write-Host "✓ Download successful (Invoke-WebRequest)"
            }
            catch {
                Write-Host "Download failed, creating placeholder..."
                # Create a simple batch file instead
                @"
@echo off
echo VanitySearch not downloaded automatically.
echo Please download manually from:
echo https://github.com/JeanLucPons/VanitySearch/releases
echo.
echo For quick test, use this python script instead.
python -c "import hashlib, base58, secrets; print('Bitcoin tools ready - manual download required')"
pause
"@ | Out-File -FilePath "C:\BitcoinTools\start_vanity.bat" -Encoding ASCII
            }
        }
        
        # Create desktop shortcut if file exists
        if (Test-Path $vanityPath) {
            $shortcutPath = "C:\Users\Public\Desktop\VanitySearch.lnk"
            $WshShell = New-Object -ComObject WScript.Shell
            $Shortcut = $WshShell.CreateShortcut($shortcutPath)
            $Shortcut.TargetPath = $vanityPath
            $Shortcut.WorkingDirectory = "C:\BitcoinTools"
            $Shortcut.Save()
            Write-Host "✓ Desktop shortcut created"
        }
        
        # Alternative: Download from different source
        Write-Host "Downloading alternative tools..."
        
        # Download KeyHunt (alternative to VanitySearch)
        $keyhuntUrl = "https://github.com/kanhavishva/KeyHunt-Cuda/releases/latest/download/keyhunt-cuda.exe"
        Invoke-WebRequest -Uri $keyhuntUrl -OutFile "C:\BitcoinTools\KeyHunt.exe" -UseBasicParsing -ErrorAction SilentlyContinue
        
        # Create Python script as backup
        Write-Host "Creating Python backup script..."
        @"
import hashlib, base58, secrets, ecdsa, os, time

def generate_bitcoin_address():
    """Generate a random Bitcoin address"""
    # Generate private key
    private_key = secrets.token_bytes(32)
    
    # Get public key
    sk = ecdsa.SigningKey.from_string(private_key, curve=ecdsa.SECP256k1)
    vk = sk.get_verifying_key()
    public_key = b'\x04' + vk.to_string()
    
    # SHA256 + RIPEMD160
    sha256 = hashlib.sha256(public_key).digest()
    ripemd160 = hashlib.new('ripemd160', sha256).digest()
    
    # Add network byte
    network_byte = b'\x00'
    payload = network_byte + ripemd160
    
    # Checksum
    checksum = hashlib.sha256(hashlib.sha256(payload).digest()).digest()[:4]
    
    # Base58 address
    address = base58.b58encode(payload + checksum).decode()
    
    # WIF private key
    wif = base58.b58encode(b'\x80' + private_key + b'\x01').decode()
    
    return address, wif

print("Bitcoin Address Generator")
print("=" * 50)
addr, wif = generate_bitcoin_address()
print(f"Address: {addr}")
print(f"Private Key (WIF): {wif}")
"@ | Out-File -FilePath "C:\BitcoinTools\generate_address.py" -Encoding UTF8
        
        Write-Host "✅ Bitcoin tools setup completed"
        
    - name: Install Python Dependencies
      shell: powershell
      run: |
        Write-Host "=== Installing Python Packages ==="
        
        # Install Python packages for Bitcoin tools
        pip install base58 ecdsa hashlib
        
        # Alternative if pip doesn't work
        python -m pip install base58
        python -m pip install ecdsa
        
        Write-Host "✓ Python packages installed"
        
    - name: Show Connection Info
      shell: cmd
      run: |
        @echo off
        
        echo ========================================
        echo ✅ RDP + BITCOIN TOOLS READY
        echo ========================================
        
        type ip.txt
        echo Username: rdpuser
        echo Password: Password123!
        echo.
        echo Bitcoin Tools Location: C:\BitcoinTools
        echo.
        echo If VanitySearch.exe not found:
        echo 1. Download manually from:
        echo    https://github.com/JeanLucPons/VanitySearch/releases
        echo 2. Save to C:\BitcoinTools\
        echo 3. Run from desktop shortcut
        echo ========================================
        
    - name: Keep Session Alive
      shell: powershell
      run: |
        Write-Host "Bitcoin RDP Session Active..."
        Write-Host "IP Address: $(Get-Content ip.txt -ErrorAction SilentlyContinue)"
        Write-Host "Tools available in: C:\BitcoinTools"
        Write-Host "Session duration: 6 hours"
        
        # Keep alive for 6 hours
        Start-Sleep -Seconds 21600

name: üöÄ Windows RDP with Tailscale

on: 
  workflow_dispatch:
    inputs:
      session_timeout:
        description: 'RDP Session Timeout (minutes)'
        required: true
        default: '360'
        type: number

env:
  SESSION_TIMEOUT: ${{ github.event.inputs.session_timeout }}

jobs:
  rdp-setup:
    runs-on: windows-latest
    
    # FIX: Use hardcoded timeout or calculated value
    timeout-minutes: 360  # Maximum GitHub allows for public repos
    
    steps:
    - name: üì¶ Checkout Repository
      uses: actions/checkout@v4
    
    - name: üîß Setup Environment
      shell: powershell
      run: |
        # Store the timeout from input
        $timeout = ${{ github.event.inputs.session_timeout }}
        Write-Host "‚è∞ Session will run for $timeout minutes"
        
        # Create log directory
        New-Item -ItemType Directory -Path "C:\RDP_Logs" -Force | Out-Null
        Set-ExecutionPolicy -ExecutionPolicy Bypass -Scope Process -Force
        
    - name: üõ°Ô∏è Install Tailscale
      shell: powershell
      run: |
        Write-Host "üì• Downloading Tailscale..."
        $tailscale_url = "https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe"
        $installer = "C:\Windows\Temp\tailscale.exe"
        
        # Download Tailscale
        try {
          Invoke-WebRequest -Uri $tailscale_url -OutFile $installer -UseBasicParsing
          Write-Host "‚úÖ Download successful"
        }
        catch {
          Write-Error "‚ùå Failed to download Tailscale"
          exit 1
        }
        
        # Silent install
        Write-Host "üîß Installing Tailscale..."
        Start-Process -FilePath $installer -ArgumentList "/S" -Wait -NoNewWindow
        Start-Sleep -Seconds 10
        
    - name: üîë Connect Tailscale
      shell: powershell
      env:
        TS_AUTH_KEY: ${{ secrets.TS_AUTH_KEY }}
      run: |
        Write-Host "üîó Connecting to Tailscale..."
        
        # Verify installation
        if (-not (Test-Path "C:\Program Files\Tailscale\tailscale.exe")) {
          Write-Error "‚ùå Tailscale not installed"
          exit 1
        }
        
        # Start Tailscale
        & "C:\Program Files\Tailscale\tailscale.exe" up --authkey="$env:TS_AUTH_KEY" --hostname="github-rdp-${{ github.run_id }}"
        
        # Get IP
        $ts_ip = & "C:\Program Files\Tailscale\tailscale.exe" ip -4
        Write-Host "‚úÖ Tailscale Connected: $ts_ip"
        
        # Save connection info
        $connection_info = @{
          ip = $ts_ip
          hostname = "github-rdp-${{ github.run_id }}"
          run_id = "${{ github.run_id }}"
        } | ConvertTo-Json
        
        Set-Content -Path "C:\RDP_Logs\connection.json" -Value $connection_info
        
    - name: ü™ü Enable RDP
      shell: powershell
      run: |
        Write-Host "üîÑ Configuring Remote Desktop..."
        
        # Enable RDP
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -Value 0
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -name "UserAuthentication" -Value 1
        
        # Configure Firewall
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop" -ErrorAction SilentlyContinue
        
    - name: üë§ Create RDP User
      shell: powershell
      run: |
        Write-Host "üë§ Setting up user account..."
        
        # Generate password
        Add-Type -AssemblyName System.Web
        $password = [System.Web.Security.Membership]::GeneratePassword(16, 4)
        $username = "githubuser"
        
        # Create user
        try {
          New-LocalUser -Name $username -Password (ConvertTo-SecureString $password -AsPlainText -Force) -FullName "GitHub RDP User" -ErrorAction Stop
          Add-LocalGroupMember -Group "Administrators" -Member $username
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username
          Set-LocalUser -Name $username -PasswordNeverExpires $true
          
          Write-Host "‚úÖ User created successfully"
          Write-Host "Username: $username"
          Write-Host "Password: $password"
        }
        catch {
          Write-Host "‚ö†Ô∏è Using default Administrator account"
          $password = "GitHubRDP@$(Get-Random -Minimum 1000 -Maximum 9999)"
          Enable-LocalUser -Name "Administrator"
          Set-LocalUser -Name "Administrator" -Password (ConvertTo-SecureString $password -AsPlainText -Force)
          $username = "Administrator"
          Write-Host "Password: $password"
        }
        
        # Save to file
        Set-Content -Path "C:\RDP_Logs\credentials.txt" -Value "Username: $username`nPassword: $password"
        
    - name: üìä Display Connection Info
      shell: powershell
      run: |
        # Get Tailscale IP
        $ts_ip = & "C:\Program Files\Tailscale\tailscale.exe" ip -4
        
        Write-Host "=========================================="
        Write-Host "‚úÖ RDP SETUP COMPLETE"
        Write-Host "=========================================="
        Write-Host "üåê CONNECT USING:"
        Write-Host "   IP Address: $ts_ip"
        Write-Host "   Port: 3389"
        Write-Host ""
        Write-Host "üíª Windows RDP Command:"
        Write-Host "   mstsc /v:$ts_ip /f"
        Write-Host ""
        Write-Host "üîó Tailscale Admin: https://login.tailscale.com/admin/machines"
        Write-Host "=========================================="
        
    - name: ‚è≥ Keep Session Alive
      shell: powershell
      run: |
        $timeout = ${{ github.event.inputs.session_timeout }}
        Write-Host "üîÑ Session active for $timeout minutes..."
        
        # Calculate seconds
        $seconds = $timeout * 60
        
        # Keep alive loop
        $counter = 0
        while ($counter -lt $seconds) {
          if ($counter % 60 -eq 0) {
            $minutes = $counter / 60
            Write-Host "‚è∞ Running for $minutes minutes..."
          }
          $counter++
          Start-Sleep -Seconds 1
        }
        
        Write-Host "‚è∞ Timeout reached, ending session..."

name: üöÄ RDP with Tailscale

on: workflow_dispatch

jobs:
  rdp:
    runs-on: windows-latest
    timeout-minutes: 360
    
    steps:
    - name: üì¶ Checkout
      uses: actions/checkout@v4
    
    - name: üîß Install & Setup Tailscale
      shell: powershell
      env:
        TS_AUTH_KEY: ${{ secrets.TS_AUTH_KEY }}
      run: |
        # Download Tailscale using curl (most reliable)
        curl.exe -fsSL -o tailscale.exe https://pkgs.tailscale.com/stable/tailscale-setup-amd64-latest.exe
        
        # Install silently
        .\tailscale.exe /S
        Start-Sleep -Seconds 10
        
        # Connect to Tailscale
        & "C:\Program Files\Tailscale\tailscale.exe" up --authkey="$env:TS_AUTH_KEY" --hostname="github-rdp"
        
        # Get IP
        $ip = & "C:\Program Files\Tailscale\tailscale.exe" ip -4
        echo "Tailscale IP: $ip"
    
    - name: ü™ü Setup RDP
      shell: powershell
      run: |
        # Enable RDP
        reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
        netsh advfirewall firewall set rule group="remote desktop" new enable=Yes
        
        # Create user
        net user githubuser "RDP@GitHub123" /add
        net localgroup administrators githubuser /add
    
    - name: üì° Show Connection Info
      shell: powershell
      run: |
        $ip = & "C:\Program Files\Tailscale\tailscale.exe" ip -4
        echo "========================================"
        echo "‚úÖ RDP READY TO CONNECT"
        echo "========================================"
        echo "IP: $ip"
        echo "User: githubuser"
        echo "Pass: RDP@GitHub123"
        echo "========================================"
    
    - name: ‚è≥ Keep Alive
      shell: powershell
      run: |
        # Run for 6 hours
        timeout /t 21600

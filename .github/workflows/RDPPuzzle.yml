name: Linux RDP with Bitcoin Tools

on: workflow_dispatch

jobs:
  setup:
    runs-on: ubuntu-latest                # Use Ubuntu runner
    timeout-minutes: 300

    steps:
      - name: Connect Tailscale
        uses: tailscale/github-action@v4
        with:
          authkey: ${{ secrets.TS_AUTH_KEY }}

      - name: Get Tailscale IP
        run: |
          sleep 10
          IP=$(tailscale ip -4)
          echo "RDP_IP=$IP" >> $GITHUB_ENV
          echo "Tailscale IP: $IP"

      - name: Install Desktop Environment and xrdp
        run: |
          sudo apt update
          # Install XFCE (lightweight) and xrdp
          sudo apt install -y xfce4 xfce4-goodies xrdp
          # Configure xrdp to use XFCE
          echo xfce4-session > ~/.xsession
          sudo systemctl enable xrdp
          sudo systemctl restart xrdp
          # Allow RDP port in firewall (ufw not active by default on GitHub runners)
          sudo ufw allow 3389/tcp || true

      - name: Create RDP User
        run: |
          USERNAME="linuxuser"
          PASSWORD=$(openssl rand -base64 12 | tr -d "=+/" | cut -c1-16)
          # Create user with home directory
          sudo useradd -m -s /bin/bash $USERNAME
          echo "$USERNAME:$PASSWORD" | sudo chpasswd
          # Add user to groups for RDP
          sudo usermod -aG sudo $USERNAME   # sudo group for admin rights
          sudo usermod -aG xrdp $USERNAME   # xrdp group (if exists)
          # Store credentials in environment
          echo "RDP_USER=$USERNAME" >> $GITHUB_ENV
          echo "RDP_PASS=$PASSWORD" >> $GITHUB_ENV
          echo "User created: $USERNAME"

      - name: Install Bitcoin Vanity Tools (VanitySearch)
        run: |
          mkdir -p ~/BitcoinTools
          cd ~/BitcoinTools
          # Download pre-compiled Linux binary from VanitySearch releases
          wget https://github.com/JeanLucPons/VanitySearch/releases/download/1.19/VanitySearch
          chmod +x VanitySearch
          # Create README
          cat > README.txt << EOF
          Bitcoin Vanity Address Generator (Linux version)
          
          Usage: ./VanitySearch [options] prefix
          Example: ./VanitySearch 1Ejaz
          More options: ./VanitySearch --help
          EOF
          # Create desktop shortcut (optional, but we'll add a launcher to ~/Desktop)
          mkdir -p ~/Desktop
          cat > ~/Desktop/VanitySearch.desktop << EOF
          [Desktop Entry]
          Name=VanitySearch
          Comment=Bitcoin Vanity Address Generator
          Exec=/home/linuxuser/BitcoinTools/VanitySearch
          Icon=utilities-terminal
          Terminal=true
          Type=Application
          Categories=Application;
          EOF
          chmod +x ~/Desktop/VanitySearch.desktop
          echo "Bitcoin tools installed in /home/linuxuser/BitcoinTools"

      - name: Display Connection Information
        run: |
          echo ""
          echo "================================================="
          echo "         LINUX RDP CONNECTION READY             "
          echo "================================================="
          echo ""
          echo "CONNECTION DETAILS:"
          echo "IP Address:     ${{ env.RDP_IP }}"
          echo "Username:       ${{ env.RDP_USER }}"
          echo "Password:       ${{ env.RDP_PASS }}"
          echo ""
          echo "CONNECT USING:"
          echo "On Windows: mstsc /v:${{ env.RDP_IP }}"
          echo "On Linux: use any RDP client (Remmina, KRDC)"
          echo ""
          echo "DESKTOP ENVIRONMENT: XFCE (lightweight)"
          echo "BITCOIN TOOLS: ~/BitcoinTools (VanitySearch)"
          echo ""
          echo "SESSION DURATION: up to 5 hours (keep-alive active)"
          echo "================================================="

      - name: Keep Session Alive
        run: |
          echo "Keeping session active for 5 hours..."
          # Simple loop that prints every 5 minutes
          END=$((SECONDS + 18000))  # 5 hours = 18000 seconds
          while [ $SECONDS -lt $END ]; do
            echo "[$(date +%H:%M:%S)] Session active - $(($END - $SECONDS)) seconds remaining"
            # Optional: simulate activity (e.g., touch a file, but not necessary)
            sleep 300   # 5 minutes
          done
          echo "Session timeout reached."

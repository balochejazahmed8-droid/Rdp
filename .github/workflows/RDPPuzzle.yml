name: Linux RDP with Bitcoin Tools

on: workflow_dispatch

jobs:
  setup:
    runs-on: ubuntu-latest
    timeout-minutes: 300

    steps:
      - name: Connect Tailscale
        uses: tailscale/github-action@v4
        with:
          authkey: ${{ secrets.TS_AUTH_KEY }}

      - name: Get Tailscale IP
        run: |
          sleep 10
          IP=$(tailscale ip -4)
          echo "RDP_IP=$IP" >> $GITHUB_ENV
          echo "Tailscale IP: $IP"

      - name: Install Desktop Environment and xrdp
        run: |
          sudo apt update
          # Install XFCE (lightweight) and xrdp
          sudo apt install -y xfce4 xfce4-goodies xrdp
          # Configure xrdp to use XFCE
          echo xfce4-session > ~/.xsession
          sudo systemctl enable xrdp
          sudo systemctl restart xrdp
          # Allow RDP port in firewall
          sudo ufw allow 3389/tcp || true

      - name: Create RDP User
        run: |
          USERNAME="linuxuser"
          PASSWORD=$(openssl rand -base64 12 | tr -d "=+/" | cut -c1-16)
          # Create user with home directory
          sudo useradd -m -s /bin/bash $USERNAME
          echo "$USERNAME:$PASSWORD" | sudo chpasswd
          # Add to groups
          sudo usermod -aG sudo $USERNAME
          sudo usermod -aG xrdp $USERNAME
          # Store credentials
          echo "RDP_USER=$USERNAME" >> $GITHUB_ENV
          echo "RDP_PASS=$PASSWORD" >> $GITHUB_ENV

      - name: Install Bitcoin Vanity Tools (compile from source)
        run: |
          # Install build dependencies
          sudo apt update
          sudo apt install -y git build-essential libssl-dev

          # Clone and compile VanitySearch
          git clone https://github.com/JeanLucPons/VanitySearch.git
          cd VanitySearch
          make

          # Create tools directory and copy binary
          mkdir -p ~/BitcoinTools
          cp VanitySearch ~/BitcoinTools/
          cd ~/BitcoinTools
          chmod +x VanitySearch

          # Create README
          cat > README.txt << 'EOF'
          Bitcoin Vanity Address Generator (Linux)
          ========================================

          Compiled from source.

          Usage: ./VanitySearch [options] prefix
          Example: ./VanitySearch 1Ejaz

          For full options: ./VanitySearch --help
          EOF

          # Create desktop shortcut for the user
          sudo mkdir -p /home/linuxuser/Desktop
          sudo bash -c "cat > /home/linuxuser/Desktop/VanitySearch.desktop << 'EOF'
          [Desktop Entry]
          Name=VanitySearch
          Comment=Bitcoin Vanity Address Generator
          Exec=/home/linuxuser/BitcoinTools/VanitySearch
          Icon=utilities-terminal
          Terminal=true
          Type=Application
          Categories=Application;
          EOF"
          sudo chmod +x /home/linuxuser/Desktop/VanitySearch.desktop
          sudo chown -R linuxuser:linuxuser /home/linuxuser/Desktop /home/linuxuser/BitcoinTools

          echo "Bitcoin tools installed in /home/linuxuser/BitcoinTools"

      - name: Display Connection Information
        run: |
          echo ""
          echo "================================================="
          echo "         LINUX RDP CONNECTION READY             "
          echo "================================================="
          echo ""
          echo "CONNECTION DETAILS:"
          echo "IP Address:     ${{ env.RDP_IP }}"
          echo "Username:       ${{ env.RDP_USER }}"
          echo "Password:       ${{ env.RDP_PASS }}"
          echo ""
          echo "CONNECT USING:"
          echo "On Windows: mstsc /v:${{ env.RDP_IP }}"
          echo ""
          echo "DESKTOP ENVIRONMENT: XFCE"
          echo "BITCOIN TOOLS: ~/BitcoinTools (VanitySearch)"
          echo ""
          echo "SESSION DURATION: up to 5 hours (keep-alive active)"
          echo "================================================="

      - name: Keep Session Alive
        run: |
          echo "Keeping session active for 5 hours..."
          END=$((SECONDS + 18000))
          while [ $SECONDS -lt $END ]; do
            echo "[$(date +%H:%M:%S)] Session active - $((($END - $SECONDS) / 60)) minutes remaining"
            sleep 300   # 5 minutes
          done
          echo "Session timeout reached."

name: RDP with Bitcoin Tools

on: workflow_dispatch

jobs:
  setup:
    runs-on: windows-latest
    timeout-minutes: 300

    steps:
      - name: Connect Tailscale
        uses: tailscale/github-action@v4
        with:
          authkey: ${{ secrets.TS_AUTH_KEY }}

      - name: Get Tailscale IP
        shell: powershell
        run: |
          Start-Sleep -Seconds 10
          $ip = (tailscale ip -4).Trim()
          if ($ip) {
            Write-Output $ip | Out-File -FilePath "$env:GITHUB_WORKSPACE\ip.txt" -Encoding ascii
            Write-Host "Tailscale IP: $ip"
          } else {
            Write-Host "ERROR: Failed to get Tailscale IP"
            exit 1
          }

      - name: Enable RDP and Create User
        shell: powershell
        run: |
          # Enable RDP
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "UserAuthentication" -Value 0 -Force
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop" -ErrorAction SilentlyContinue
          New-NetFirewallRule -DisplayName "RDP Custom" -Direction Inbound -Protocol TCP -LocalPort 3389 -Action Allow -ErrorAction SilentlyContinue
          
          # Create user
          $username = "rdpuser"
          $passPlain = -join ((65..90) + (97..122) + (48..57) | Get-Random -Count 16 | ForEach-Object {[char]$_})
          
          net user $username /delete 2>$null
          net user $username $passPlain /add /y
          net localgroup Administrators $username /add
          net localgroup "Remote Desktop Users" $username /add
          
          # Save password to environment
          "PASSWORD=$passPlain" | Out-File -FilePath $env:GITHUB_ENV -Append
          Write-Host "User created: $username"

      - name: Setup Bitcoin Vanity Tools
        shell: powershell
        run: |
          $toolsDir = "C:\BitcoinVanity"
          New-Item -ItemType Directory -Path $toolsDir -Force | Out-Null

          Write-Host "Downloading VanitySearch v1.19..."
          $vsUrl = "https://github.com/JeanLucPons/VanitySearch/releases/download/1.19/VanitySearch.exe"
          $vsPath = "$toolsDir\VanitySearch.exe"

          try {
            $retryCount = 0
            $maxRetries = 3
            while ($retryCount -lt $maxRetries) {
              try {
                Invoke-WebRequest -Uri $vsUrl -OutFile $vsPath -UseBasicParsing -TimeoutSec 120
                Write-Host "VanitySearch downloaded successfully"
                break
              } catch {
                $retryCount++
                Write-Host "Download attempt $retryCount failed: $_"
                if ($retryCount -eq $maxRetries) {
                  Write-Host "ERROR: Failed to download VanitySearch after $maxRetries attempts."
                  exit 1   # Fail the job so user knows tool is missing
                }
                Start-Sleep -Seconds 5
              }
            }
          } catch {
            Write-Host "Fatal error during download: $_"
            exit 1
          }

          # Create README
          $readmeLines = @(
            "Bitcoin Vanity Address Generator (v1.19)",
            "",
            "File: VanitySearch.exe is ready in this folder.",
            "",
            "Quick examples:",
            "  VanitySearch.exe 1Ejaz         # Search for addresses starting with 1Ejaz",
            "  VanitySearch.exe -t 0 1Love    # Use all CPU threads",
            "  VanitySearch.exe -gpu 1My      # Try GPU mode (not available on GitHub)",
            "",
            "More options:",
            "  VanitySearch.exe --help"
          )
          $readmeContent = $readmeLines -join "`r`n"
          Set-Content -Path "$toolsDir\README.txt" -Value $readmeContent -Encoding UTF8

          # Create batch file
          $batLines = @(
            "@echo off",
            "title Bitcoin Vanity Tools",
            "echo Bitcoin Vanity Address Generator",
            "echo ================================",
            "echo.",
            "echo Tool: VanitySearch.exe",
            "echo Location: %~dp0",
            "echo.",
            "echo Examples:",
            "echo   VanitySearch.exe 1Ejaz",
            "echo   VanitySearch.exe -t 0 1Love",
            "echo.",
            "echo Check README.txt for more details",
            "echo.",
            "pause"
          )
          $batContent = $batLines -join "`r`n"
          Set-Content -Path "$toolsDir\start.bat" -Value $batContent -Encoding ASCII

          Write-Host "Tools folder created: $toolsDir"

      - name: Show Connection Info
        shell: powershell
        run: |
          Write-Host ""
          Write-Host "======================================"
          Write-Host "    RDP + BITCOIN VANITY TOOLS READY"
          Write-Host "======================================"
          Write-Host ""

          $ipPath = "$env:GITHUB_WORKSPACE\ip.txt"
          if (Test-Path $ipPath) {
            $ip = Get-Content $ipPath -Raw
            Write-Host "Tailscale IP: $ip"
            Write-Host "Connect: mstsc /v:$ip"
          } else {
            Write-Host "ERROR: No IP file found"
          }

          Write-Host ""
          Write-Host "Username: rdpuser"
          Write-Host "Password: $($env:PASSWORD)"
          Write-Host ""
          Write-Host "Tools location: C:\BitcoinVanity"
          Write-Host ""
          Write-Host "Note: Session will stay active for 5 hours (job timeout)"
          Write-Host "======================================"

      - name: Keep Session Alive (Idle Wait)
        shell: powershell
        run: |
          Write-Host "Job will remain active for 5 hours. You can RDP into the machine."
          Write-Host "The runner will shut down automatically after 5 hours."
          $endTime = (Get-Date).AddHours(5)
          Write-Host "Current time: $(Get-Date)"
          Write-Host "End time: $endTime"
          while ((Get-Date) -lt $endTime) {
            $remaining = ($endTime - (Get-Date)).TotalMinutes
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Time remaining: $([math]::Round($remaining)) minutes"
            Start-Sleep -Seconds 60
          }
          Write-Host "Session timeout reached. Shutting down..."

name: Linux RDP with Bitcoin Tools

on: workflow_dispatch

jobs:
  setup:
    runs-on: ubuntu-latest
    timeout-minutes: 300

    steps:
      - name: Connect Tailscale
        uses: tailscale/github-action@v4
        with:
          authkey: ${{ secrets.TS_AUTH_KEY }}

      - name: Get Tailscale IP
        run: |
          sleep 10
          IP=$(tailscale ip -4)
          echo "RDP_IP=$IP" >> $GITHUB_ENV
          echo "Tailscale IP: $IP"

      - name: Install Desktop Environment and xrdp
        run: |
          sudo apt update
          sudo apt install -y xfce4 xfce4-goodies xrdp
          echo xfce4-session > ~/.xsession
          sudo systemctl enable xrdp
          sudo systemctl restart xrdp
          sudo ufw allow 3389/tcp || true

      - name: Create RDP User
        run: |
          USERNAME="linuxuser"
          PASSWORD=$(openssl rand -base64 12 | tr -d "=+/" | cut -c1-16)
          sudo useradd -m -s /bin/bash $USERNAME
          echo "$USERNAME:$PASSWORD" | sudo chpasswd
          sudo usermod -aG sudo $USERNAME
          sudo usermod -aG xrdp $USERNAME
          echo "RDP_USER=$USERNAME" >> $GITHUB_ENV
          echo "RDP_PASS=$PASSWORD" >> $GITHUB_ENV

      - name: Install Bitcoin Vanity Tools (with fallback)
        run: |
          # Create tools directory
          mkdir -p ~/BitcoinTools
          cd ~/BitcoinTools

          # Function to install from binary
          install_binary() {
            echo "Attempting binary download..."
            wget -q https://github.com/JeanLucPons/VanitySearch/releases/download/1.19/VanitySearch_Linux || \
            wget -q https://github.com/JeanLucPons/VanitySearch/releases/download/1.19/vanitysearch-linux-amd64 || \
            wget -q https://github.com/JeanLucPons/VanitySearch/releases/download/1.19/VanitySearch || \
            wget -q https://github.com/JeanLucPons/VanitySearch/releases/download/v1.19/VanitySearch_Linux

            if ls VanitySearch* 1> /dev/null 2>&1; then
              chmod +x VanitySearch*
              echo "Binary installed successfully"
              return 0
            else
              return 1
            fi
          }

          # Try binary first
          if install_binary; then
            BINARY_INSTALLED=true
          else
            echo "Binary download failed, compiling from source..."
            # Install build dependencies
            sudo apt update
            sudo apt install -y git build-essential libssl-dev

            # Clone repository
            git clone https://github.com/JeanLucPons/VanitySearch.git
            cd VanitySearch

            # Comprehensive patch: Add Timer.h to all files that need it
            echo "Applying Timer fix to all relevant files..."
            for file in main.cpp cpu-miner.cpp cli.cpp; do
              if [ -f "$file" ]; then
                # Check if Timer.h is already included
                if ! grep -q '#include "Timer.h"' "$file"; then
                  sed -i '1i#include "Timer.h"' "$file"
                fi
              fi
            done

            # Also patch any file that uses Timer::getSeed32
            grep -rl "Timer::getSeed32" . --include="*.cpp" | while read f; do
              if ! grep -q '#include "Timer.h"' "$f"; then
                sed -i '1i#include "Timer.h"' "$f"
              fi
            done

            # Compile
            make

            if [ -f VanitySearch ]; then
              cp VanitySearch ~/BitcoinTools/
            else
              echo "Compilation failed, exiting."
              exit 1
            fi
            cd ~/BitcoinTools
          fi

          # Ensure binary is executable
          chmod +x VanitySearch*

          # Create README
          cat > README.txt << 'EOF'
          Bitcoin Vanity Address Generator (Linux)
          ========================================

          Usage: ./VanitySearch [options] prefix
          Example: ./VanitySearch 1Ejaz

          For full options: ./VanitySearch --help
          EOF

          # Create desktop shortcut for the RDP user
          sudo mkdir -p /home/linuxuser/Desktop
          sudo bash -c "cat > /home/linuxuser/Desktop/VanitySearch.desktop << 'EOF'
          [Desktop Entry]
          Name=VanitySearch
          Comment=Bitcoin Vanity Address Generator
          Exec=/home/linuxuser/BitcoinTools/VanitySearch
          Icon=utilities-terminal
          Terminal=true
          Type=Application
          Categories=Application;
          EOF"
          sudo chmod +x /home/linuxuser/Desktop/VanitySearch.desktop
          sudo chown -R linuxuser:linuxuser /home/linuxuser/Desktop /home/linuxuser/BitcoinTools

          echo "Bitcoin tools installed in /home/linuxuser/BitcoinTools"

      - name: Display Connection Information
        run: |
          echo ""
          echo "================================================="
          echo "         LINUX RDP CONNECTION READY             "
          echo "================================================="
          echo ""
          echo "CONNECTION DETAILS:"
          echo "IP Address:     ${{ env.RDP_IP }}"
          echo "Username:       ${{ env.RDP_USER }}"
          echo "Password:       ${{ env.RDP_PASS }}"
          echo ""
          echo "CONNECT USING:"
          echo "On Windows: mstsc /v:${{ env.RDP_IP }}"
          echo ""
          echo "DESKTOP ENVIRONMENT: XFCE"
          echo "BITCOIN TOOLS: ~/BitcoinTools (VanitySearch)"
          echo ""
          echo "SESSION DURATION: up to 5 hours (keep-alive active)"
          echo "================================================="

      - name: Keep Session Alive
        run: |
          echo "Keeping session active for 5 hours..."
          END=$((SECONDS + 18000))
          while [ $SECONDS -lt $END ]; do
            echo "[$(date +%H:%M:%S)] Session active - $((($END - $SECONDS) / 60)) minutes remaining"
            sleep 300
          done
          echo "Session timeout reached."

name: RDP with Bitcoin Tools

on: workflow_dispatch

jobs:
  setup:
    runs-on: windows-latest
    timeout-minutes: 300

    steps:
      - name: Connect Tailscale
        uses: tailscale/github-action@v4
        with:
          authkey: ${{ secrets.TS_AUTH_KEY }}

      - name: Get Tailscale IP
        shell: powershell
        run: |
          tailscale ip -4 | Out-File -FilePath "$env:GITHUB_WORKSPACE\ip.txt" -Encoding ascii
          Get-Content "$env:GITHUB_WORKSPACE\ip.txt"

      - name: Enable RDP and Create User
        shell: powershell
        run: |
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "UserAuthentication" -Value 0 -Force
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop" -ErrorAction SilentlyContinue

          $username = "rdpuser"
          $passPlain = -join ((65..90) + (97..122) + (48..57) | Get-Random -Count 16 | ForEach-Object {[char]$_})
          $password = ConvertTo-SecureString $passPlain -AsPlainText -Force

          net user $username /delete 2>$null
          net user $username $passPlain /add /y
          net localgroup Administrators $username /add
          net localgroup "Remote Desktop Users" $username /add

          echo "PASSWORD=$passPlain" >> $env:GITHUB_ENV

      - name: Setup Bitcoin Vanity Tools
        shell: powershell
        run: |
          $toolsDir = "C:\BitcoinVanity"
          New-Item -ItemType Directory -Path $toolsDir -Force | Out-Null

          Write-Host "Downloading VanitySearch v1.19..."
          $vsUrl = "https://github.com/JeanLucPons/VanitySearch/releases/download/1.19/VanitySearch.exe"
          $vsPath = "$toolsDir\VanitySearch.exe"

          try {
            Invoke-WebRequest -Uri $vsUrl -OutFile $vsPath -UseBasicParsing -TimeoutSec 60
            Write-Host "VanitySearch downloaded successfully"
          } catch {
            Write-Host "Download failed: $_"
          }

          $readme = @'
Bitcoin Vanity Address Generator (v1.19)

File: VanitySearch.exe is ready in this folder.

Quick examples:
  VanitySearch.exe 1Ejaz         # Search for addresses starting with 1Ejaz
  VanitySearch.exe -t 0 1Love    # Use all CPU threads
  VanitySearch.exe -gpu 1My      # Try GPU mode (not available on GitHub)

More options:
  VanitySearch.exe --help
'@
          Set-Content -Path "$toolsDir\README.txt" -Value $readme -Encoding UTF8

          $bat = @'
@echo off
title Bitcoin Vanity Tools
echo VanitySearch is ready!
echo.
echo Check README.txt for examples
echo.
pause
'@
          Set-Content -Path "$toolsDir\start.bat" -Value $bat -Encoding ASCII

          Write-Host "Tools folder created: $toolsDir"

      - name: Show Connection Info
        shell: powershell
        run: |
          Write-Host "======================================"
          Write-Host "RDP + BITCOIN VANITY TOOLS READY"
          Write-Host "======================================"

          $ip = Get-Content "$env:GITHUB_WORKSPACE\ip.txt" -ErrorAction SilentlyContinue
          if ($ip) {
            Write-Host "Tailscale IP: $ip"
            Write-Host "Connect: mstsc /v:$ip"
          } else {
            Write-Host "No IP found - check Tailscale step"
          }

          Write-Host ""
          Write-Host "Username: rdpuser"
          Write-Host "Password: $($env:PASSWORD)"
          Write-Host ""
          Write-Host "Tools location: C:\BitcoinVanity"
          Write-Host "======================================"

      - name: Keep Session Alive
        shell: powershell
        run: |
          try {
            Add-Type -AssemblyName System.Windows.Forms -ErrorAction Stop
            Write-Host "Keep-alive loop started (mouse moves every 5 min)"
            while ($true) {
              $x = Get-Random -Maximum 1800
              $y = Get-Random -Maximum 1000
              [System.Windows.Forms.Cursor]::Position = New-Object System.Drawing.Point($x, $y)
              Start-Sleep -Seconds 300
            }
          } catch {
            Write-Host "Mouse move failed: $_"
            Write-Host "Falling back to long sleep (6 hours)"
            Start-Sleep -Seconds 21600
          }
